

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>dymos.phases.phase_base &#8212; dymos 0.8.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.8.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">dymos 0.8.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for dymos.phases.phase_base</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Iterable</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">iteritems</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>

<span class="kn">from</span> <span class="nn">openmdao.api</span> <span class="k">import</span> <span class="n">Group</span><span class="p">,</span> <span class="n">IndepVarComp</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.general_utils</span> <span class="k">import</span> <span class="n">warn_deprecation</span>
<span class="kn">from</span> <span class="nn">openmdao.core.system</span> <span class="k">import</span> <span class="n">System</span>

<span class="kn">from</span> <span class="nn">openmdao.utils.logger_utils</span> <span class="k">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.general_utils</span> <span class="k">import</span> <span class="n">warn_deprecation</span>

<span class="kn">from</span> <span class="nn">dymos.phases.components</span> <span class="k">import</span> <span class="n">BoundaryConstraintComp</span>
<span class="kn">from</span> <span class="nn">dymos.phases.components</span> <span class="k">import</span> <span class="n">ControlInputComp</span>
<span class="kn">from</span> <span class="nn">dymos.phases.components</span> <span class="k">import</span> <span class="n">DesignParameterInputComp</span>
<span class="kn">from</span> <span class="nn">dymos.phases.components</span> <span class="k">import</span> <span class="n">TimeComp</span>
<span class="kn">from</span> <span class="nn">dymos.phases.options</span> <span class="k">import</span> <span class="n">ControlOptionsDictionary</span><span class="p">,</span> <span class="n">DesignParameterOptionsDictionary</span><span class="p">,</span> \
    <span class="n">StateOptionsDictionary</span><span class="p">,</span> <span class="n">TimeOptionsDictionary</span>
<span class="kn">from</span> <span class="nn">dymos.phases.components</span> <span class="k">import</span> <span class="n">ControlRateComp</span>
<span class="kn">from</span> <span class="nn">dymos.phases.grid_data</span> <span class="k">import</span> <span class="n">GridData</span>
<span class="kn">from</span> <span class="nn">dymos.ode_options</span> <span class="k">import</span> <span class="n">ODEOptions</span>
<span class="kn">from</span> <span class="nn">dymos.utils.misc</span> <span class="k">import</span> <span class="n">get_rate_units</span>
<span class="kn">from</span> <span class="nn">dymos.utils.misc</span> <span class="k">import</span> <span class="n">CoerceDesvar</span>


<span class="n">_unspecified</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">PhaseBase</span><span class="p">(</span><span class="n">Group</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">PhaseBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span> <span class="o">=</span> <span class="n">TimeOptionsDictionary</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_constraints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ode_controls</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_extents</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># check that ode_class is appropriate</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ode_class&#39;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ode_class must be a class, not an instance.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ode_class&#39;</span><span class="p">],</span> <span class="n">System</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ode_class must be derived from openmdao.core.System.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ode_class&#39;</span><span class="p">],</span> <span class="s1">&#39;ode_options&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ode_class&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ode_options</span><span class="p">,</span> <span class="n">ODEOptions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ode_class has no ODE metadata.  Use @declare_time, @declare_state&#39;</span>
                             <span class="s1">&#39;and @declare_control to assign ODE metadata.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ode_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ode_class&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ode_options</span>

        <span class="c1"># Copy default value for options from the ODEOptions</span>
        <span class="k">for</span> <span class="n">state_name</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ode_options</span><span class="o">.</span><span class="n">_states</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">state_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">StateOptionsDictionary</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">state_name</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">state_name</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">state_name</span><span class="p">][</span><span class="s1">&#39;targets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;targets&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">state_name</span><span class="p">][</span><span class="s1">&#39;rate_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;rate_source&#39;</span><span class="p">]</span>

        <span class="c1"># Integration variable options default to values from the RHS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_options</span><span class="o">.</span><span class="n">_time_options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;targets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_options</span><span class="o">.</span><span class="n">_time_options</span><span class="p">[</span><span class="s1">&#39;targets&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Required metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="s1">&#39;num_segments&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Number of segments&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="s1">&#39;ode_class&#39;</span><span class="p">,</span>
                             <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;System defining the ODE&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="s1">&#39;ode_init_kwargs&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">{},</span>
                             <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Keyword arguments provided when initializing the ODE System&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="s1">&#39;transcription&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gauss-lobatto&#39;</span><span class="p">,</span> <span class="s1">&#39;radau-ps&#39;</span><span class="p">],</span>
                             <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Transcription technique of the optimal control problem.&#39;</span><span class="p">)</span>

        <span class="c1"># Optional metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span>
            <span class="s1">&#39;segment_ends&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="n">Iterable</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Iterable of locations of segment ends or None for equally spaced segments&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span>
            <span class="s1">&#39;transcription_order&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Order of the transcription&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span>
            <span class="s1">&#39;compressed&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Use compressed transcription&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_state_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">_unspecified</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                          <span class="n">fix_initial</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fix_final</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initial_bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">final_bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">defect_scaler</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set options that apply the EOM state variable of the given name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the state variable in the RHS.</span>
<span class="sd">        units : str or None</span>
<span class="sd">            Units in which the state variable is defined.  Internally components may use different</span>
<span class="sd">            units for the state variable, but the IndepVarComp which provides its value will provide</span>
<span class="sd">            it in these units, and collocation defects will use these units.  If units is not</span>
<span class="sd">            specified here then the value as defined in the ODEOptions (@declare_state) will be</span>
<span class="sd">            used.</span>
<span class="sd">        val :  ndarray</span>
<span class="sd">            The default value of the state at the state discretization nodes of the phase.</span>
<span class="sd">        fix_initial : bool(False)</span>
<span class="sd">            If True, omit the first value of the state from the design variables (prevent the</span>
<span class="sd">            optimizer from changing it).</span>
<span class="sd">        fix_final : bool(False)</span>
<span class="sd">            If True, omit the final value of the state from the design variables (prevent the</span>
<span class="sd">            optimizer from changing it).</span>
<span class="sd">        lower : float or ndarray or None (None)</span>
<span class="sd">            The lower bound of the state at the nodes of the phase.</span>
<span class="sd">        upper : float or ndarray or None (None)</span>
<span class="sd">            The upper bound of the state at the nodes of the phase.</span>
<span class="sd">        scaler : float or ndarray or None (None)</span>
<span class="sd">            The scaler of the state value at the nodes of the phase.</span>
<span class="sd">        adder : float or ndarray or None (None)</span>
<span class="sd">            The adder of the state value at the nodes of the phase.</span>
<span class="sd">        ref0 : float or ndarray or None (None)</span>
<span class="sd">            The zero-reference value of the state at the nodes of the phase.</span>
<span class="sd">        ref : float or ndarray or None (None)</span>
<span class="sd">            The unit-reference value of the state at the nodes of the phase</span>
<span class="sd">        defect_scaler : float or ndarray (1.0)</span>
<span class="sd">            The scaler of the state defect at the collocation nodes of the phase.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_unspecified</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;fix_initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fix_initial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;fix_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fix_final</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;initial_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;final_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;scaler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;adder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;ref0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;defect_scaler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defect_scaler</span>

    <span class="k">def</span> <span class="nf">add_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">fix_initial</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fix_final</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dynamic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">continuity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">rate_continuity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rate_continuity_scaler</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">rate2_continuity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rate2_continuity_scaler</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">rate_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rate2_param</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a dynamic control variable to be tied to a parameter in the ODE.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the controllable parameter in the ODE.</span>
<span class="sd">        val : float or ndarray</span>
<span class="sd">            Default value of the control at all nodes.  If val scalar and the control</span>
<span class="sd">            is dynamic it will be broadcast.</span>
<span class="sd">        units : str or None or 0</span>
<span class="sd">            Units in which the control variable is defined.  If 0, use the units declared</span>
<span class="sd">            for the parameter in the ODE.</span>
<span class="sd">        dynamic : bool (Deprecated)</span>
<span class="sd">            If True (default) this is a dynamic control, the values provided correspond to</span>
<span class="sd">            the number of nodes in the phase.  If False, this is a static control, sized (1,),</span>
<span class="sd">            and that value is broadcast to all nodes within the phase.</span>
<span class="sd">        opt : bool</span>
<span class="sd">            If True (default) the value(s) of this control will be design variables in</span>
<span class="sd">            the optimization problem, in the path &#39;phase_name.indep_controls.controls:control_name&#39;.</span>
<span class="sd">            If False, the values of this control will exist in</span>
<span class="sd">            &#39;phase_name.input_controls.controls:control_name&#39;, where it may be connected to</span>
<span class="sd">            external sources if desired.</span>
<span class="sd">        lower : float or ndarray</span>
<span class="sd">            The lower bound of the control at the nodes of the phase.</span>
<span class="sd">        upper : float or ndarray</span>
<span class="sd">            The upper bound of the control at the nodes of the phase.</span>
<span class="sd">        scaler : float or ndarray</span>
<span class="sd">            The scaler of the control value at the nodes of the phase.</span>
<span class="sd">        adder : float or ndarray</span>
<span class="sd">            The adder of the control value at the nodes of the phase.</span>
<span class="sd">        ref0 : float or ndarray</span>
<span class="sd">            The zero-reference value of the control at the nodes of the phase.</span>
<span class="sd">        ref : float or ndarray</span>
<span class="sd">            The unit-reference value of the control at the nodes of the phase</span>
<span class="sd">        contiuity : bool or None</span>
<span class="sd">            True if continuity in the value of the control is desired at the segment bounds.</span>
<span class="sd">            See notes about default values for continuity.</span>
<span class="sd">        rate_continuity : bool or None</span>
<span class="sd">            True if continuity in the rate of the control is desired at the segment bounds.  This</span>
<span class="sd">            rate is normalized to segment tau space.</span>
<span class="sd">            See notes about default values for continuity.</span>
<span class="sd">        rate_continuity_scaler : float or ndarray</span>
<span class="sd">            The scaler to use for the rate_continuity constraint given to the optimizer.</span>
<span class="sd">        rate2_continuity : bool or None</span>
<span class="sd">            True if continuity in the second derivative of the control is desired at the</span>
<span class="sd">            segment bounds. This second derivative is normalized to segment tau space.</span>
<span class="sd">            See notes about default values for continuity.</span>
<span class="sd">        rate2_continuity_scaler : float or ndarray</span>
<span class="sd">            The scaler to use for the rate2_continuity constraint given to the optimizer.</span>
<span class="sd">        rate_param : None or str</span>
<span class="sd">            The name of the parameter in the ODE to which the first time-derivative</span>
<span class="sd">            of the control value is connected.</span>
<span class="sd">        rate2_param : None or str</span>
<span class="sd">            The name of the parameter in the ODE to which the second time-derivative</span>
<span class="sd">            of the control value is connected.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If continuity is None or rate continuity is None, the default value for</span>
<span class="sd">        continuity is True and rate continuity of False.</span>

<span class="sd">        The default value of continuity and rate continuity for input controls (opt=False)</span>
<span class="sd">        is False.</span>

<span class="sd">        The user may override these defaults by specifying them as True or False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> has already been added as a control.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> has already been added as a design parameter.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">dynamic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn_deprecation</span><span class="p">(</span><span class="s1">&#39;Keyword dynamic provided in add_control when adding control </span><span class="si">{0}</span><span class="s1">. &#39;</span>
                             <span class="s1">&#39;Static controls should be added to the phase via the &#39;</span>
                             <span class="s1">&#39;add_design_parameter method.  In future versions, all controls will&#39;</span>
                             <span class="s1">&#39;be considered dynamic&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dynamic</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_design_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">scaler</span><span class="p">,</span> <span class="n">adder</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span>
                                          <span class="n">ref0</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dynamic</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ControlOptionsDictionary</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_options</span><span class="o">.</span><span class="n">_parameters</span><span class="p">:</span>
            <span class="n">ode_param_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_options</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ode_param_info</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ode_param_info</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rate_used</span> <span class="o">=</span> \
                <span class="n">rate_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rate_param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_options</span><span class="o">.</span><span class="n">_parameters</span>
            <span class="n">rate2_used</span> <span class="o">=</span> \
                <span class="n">rate2_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rate2_param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_options</span><span class="o">.</span><span class="n">_parameters</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rate_used</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rate2_used</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> is not a controllable parameter in the ODE system, nor is it &#39;</span> \
                          <span class="s1">&#39;connected to one through its rate or second derivative.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rate_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ode_rate_param_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_options</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">rate_param</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;rate_param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate_param</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ode_rate_param_info</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rate2_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ode_rate2_param_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_options</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">rate2_param</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;rate2_param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate2_param</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ode_rate2_param_info</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>

        <span class="c1"># Don&#39;t allow the user to provide desvar options if the control is not optimal</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">:</span>
            <span class="n">illegal_options</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;upper&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">adder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;adder&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ref0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">continuity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;continuity&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rate_continuity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rate_continuity&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">illegal_options</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Invalid options for non-optimal control </span><span class="si">{0}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> \
                      <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">illegal_options</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;dynamic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dynamic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;fix_initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fix_initial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;fix_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fix_final</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;scaler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;adder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;ref0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;rate_continuity_scaler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate_continuity_scaler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;rate2_continuity_scaler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate2_continuity_scaler</span>

        <span class="k">if</span> <span class="n">continuity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;continuity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;continuity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">continuity</span>

        <span class="k">if</span> <span class="n">rate_continuity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;rate_continuity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;rate_continuity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate_continuity</span>

        <span class="k">if</span> <span class="n">rate2_continuity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;rate2_continuity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;rate2_continuity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate2_continuity</span>

        <span class="k">if</span> <span class="n">units</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>

    <span class="k">def</span> <span class="nf">add_design_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rate_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">rate2_param</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Declares that a parameter of the ODE is to potentially be used as an optimal control.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the controllable parameter in the ODE.</span>
<span class="sd">        val : float or ndarray</span>
<span class="sd">            Default value of the control at all nodes.  If val scalar and the control</span>
<span class="sd">            is dynamic it will be broadcast.</span>
<span class="sd">        units : str or None or 0</span>
<span class="sd">            Units in which the control variable is defined.  If 0, use the units declared</span>
<span class="sd">            for the parameter in the ODE.</span>
<span class="sd">        opt : bool</span>
<span class="sd">            If True (default) the value(s) of this control will be design variables in</span>
<span class="sd">            the optimization problem, in the path &#39;phase_name.indep_controls.controls:control_name&#39;.</span>
<span class="sd">            If False, the values of this control will exist in</span>
<span class="sd">            &#39;phase_name.input_controls.controls:control_name&#39;, where it may be connected to</span>
<span class="sd">            external sources if desired.</span>
<span class="sd">        lower : float or ndarray</span>
<span class="sd">            The lower bound of the control at the nodes of the phase.</span>
<span class="sd">        upper : float or ndarray</span>
<span class="sd">            The upper bound of the control at the nodes of the phase.</span>
<span class="sd">        scaler : float or ndarray</span>
<span class="sd">            The scaler of the control value at the nodes of the phase.</span>
<span class="sd">        adder : float or ndarray</span>
<span class="sd">            The adder of the control value at the nodes of the phase.</span>
<span class="sd">        ref0 : float or ndarray</span>
<span class="sd">            The zero-reference value of the control at the nodes of the phase.</span>
<span class="sd">        ref : float or ndarray</span>
<span class="sd">            The unit-reference value of the control at the nodes of the phase</span>
<span class="sd">        rate_param : None or str</span>
<span class="sd">            The name of the parameter in the ODE to which the first time-derivative</span>
<span class="sd">            of the control value is connected. Rates of design parameters are always zero,</span>
<span class="sd">            but this is included for consistency with dynamic controls.</span>
<span class="sd">        rate2_param : None or str</span>
<span class="sd">            The name of the parameter in the ODE to which the second time-derivative</span>
<span class="sd">            of the control value is connected. Rates of design parameters are always zero,</span>
<span class="sd">            but this is included for consistency with dynamic controls.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> has already been added as a control.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> has already been added as a design parameter.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">DesignParameterOptionsDictionary</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_options</span><span class="o">.</span><span class="n">_parameters</span><span class="p">:</span>
            <span class="n">ode_param_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_options</span><span class="o">.</span><span class="n">_parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ode_param_info</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ode_param_info</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> is not a controllable parameter in the ODE system.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="c1"># Don&#39;t allow the user to provide desvar options if the design parameter is not a desvar</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">:</span>
            <span class="n">illegal_options</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;upper&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">adder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;adder&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ref0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">illegal_options</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Invalid options for non-optimal control:&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">illegal_options</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;scaler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;adder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;ref0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref0</span>

        <span class="k">if</span> <span class="n">units</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>

    <span class="k">def</span> <span class="nf">add_boundary_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">constraint_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">upper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linear</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a boundary constraint to a variable in the phase.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : string</span>
<span class="sd">            Name of the variable to constrain.  If name is not a state, control, or &#39;time&#39;,</span>
<span class="sd">            then this is assumed to be the path of the variable to be constrained in the ODE.</span>
<span class="sd">        loc : string</span>
<span class="sd">            The location of the boundary constraint (&#39;initial&#39; or &#39;final&#39;)</span>
<span class="sd">        constraint_name : string or None</span>
<span class="sd">            The name of the variable as provided to the boundary constraint comp.  By</span>
<span class="sd">            default this is the last element in `name` when split by dots.  The user may</span>
<span class="sd">            override the constraint name if splitting the path causes name collisions.</span>
<span class="sd">        units : str or None</span>
<span class="sd">            The units in which the boundary constraint is to be applied.  If None, use the</span>
<span class="sd">            units associated with the constrained output.  If provided, must be compatible with</span>
<span class="sd">            the variables units.</span>
<span class="sd">        lower : float or ndarray, optional</span>
<span class="sd">            Lower boundary for the variable</span>
<span class="sd">        upper : float or ndarray, optional</span>
<span class="sd">            Upper boundary for the variable</span>
<span class="sd">        equals : float or ndarray, optional</span>
<span class="sd">            Equality constraint value for the variable</span>
<span class="sd">        ref : float or ndarray, optional</span>
<span class="sd">            Value of response variable that scales to 1.0 in the driver.</span>
<span class="sd">        ref0 : float or ndarray, optional</span>
<span class="sd">            Value of response variable that scales to 0.0 in the driver.</span>
<span class="sd">        adder : float or ndarray, optional</span>
<span class="sd">            Value to add to the model value to get the scaled value. Adder</span>
<span class="sd">            is first in precedence.</span>
<span class="sd">        scaler : float or ndarray, optional</span>
<span class="sd">            value to multiply the model value to get the scaled value. Scaler</span>
<span class="sd">            is second in precedence.</span>
<span class="sd">        linear : bool</span>
<span class="sd">            Set to True if constraint is linear. Default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;initial&#39;</span><span class="p">,</span> <span class="s1">&#39;final&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid boundary constraint location (</span><span class="si">{0}</span><span class="s1">). must be &#39;</span>
                             <span class="s1">&#39;&quot;initial&quot; or &quot;final&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">constraint_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">constraint_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;constraint_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraint_name</span>

        <span class="k">if</span> <span class="n">loc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">loc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">loc</span><span class="p">][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">loc</span><span class="p">][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">loc</span><span class="p">][</span><span class="s1">&#39;equals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">equals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">loc</span><span class="p">][</span><span class="s1">&#39;scaler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">loc</span><span class="p">][</span><span class="s1">&#39;adder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">loc</span><span class="p">][</span><span class="s1">&#39;ref0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">loc</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">loc</span><span class="p">][</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">loc</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>

    <span class="k">def</span> <span class="nf">add_path_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">constraint_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">upper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linear</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a path constraint to a variable in the phase.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : string</span>
<span class="sd">            Name of the response variable in the system.</span>
<span class="sd">        constraint_name : string or None</span>
<span class="sd">            The name of the variable as provided to the boundary constraint comp.  By</span>
<span class="sd">            default this is the last element in `name` when split by dots.  The user may</span>
<span class="sd">            override the constraint name if splitting the path causes name collisions.</span>
<span class="sd">        units : str or None</span>
<span class="sd">            The units in which the boundary constraint is to be applied.  If None, use the</span>
<span class="sd">            units associated with the constrained output.  If provided, must be compatible with</span>
<span class="sd">            the variables units.</span>
<span class="sd">        lower : float or ndarray, optional</span>
<span class="sd">            Lower boundary for the variable</span>
<span class="sd">        upper : float or ndarray, optional</span>
<span class="sd">            Upper boundary for the variable</span>
<span class="sd">        equals : float or ndarray, optional</span>
<span class="sd">            Equality constraint value for the variable</span>
<span class="sd">        ref : float or ndarray, optional</span>
<span class="sd">            Value of response variable that scales to 1.0 in the driver.</span>
<span class="sd">        ref0 : float or ndarray, optional</span>
<span class="sd">            Value of response variable that scales to 0.0 in the driver.</span>
<span class="sd">        adder : float or ndarray, optional</span>
<span class="sd">            Value to add to the model value to get the scaled value. Adder</span>
<span class="sd">            is first in precedence.</span>
<span class="sd">        scaler : float or ndarray, optional</span>
<span class="sd">            value to multiply the model value to get the scaled value. Scaler</span>
<span class="sd">            is second in precedence.</span>
<span class="sd">        linear : bool</span>
<span class="sd">            Set to True if constraint is linear. Default is False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">constraint_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">constraint_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_constraints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;constraint_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraint_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_path_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;equals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">equals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;scaler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;adder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;ref0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>

    <span class="k">def</span> <span class="nf">set_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">adder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parallel_deriv_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">vectorize_derivs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allows the user to set an objective in the phase.  If name is not a state,</span>
<span class="sd">        control, or &#39;time&#39;, then this is assumed to be the path of the variable</span>
<span class="sd">        to be constrained in the RHS.</span>

<span class="sd">        The default OpenMDAO `add_objective` method may still be used with the correct</span>
<span class="sd">        path name to the response, but this method is intended to be</span>
<span class="sd">        transcription-independent.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the response variable in the system.</span>
<span class="sd">        loc : str</span>
<span class="sd">            Where in the phase the objective is to be evaluated.  Valid</span>
<span class="sd">            options are &#39;start&#39; and &#39;end&#39;.  The default is &#39;end&#39;.</span>
<span class="sd">        ref : float or ndarray, optional</span>
<span class="sd">            Value of response variable that scales to 1.0 in the driver.</span>
<span class="sd">        ref0 : float or ndarray, optional</span>
<span class="sd">            Value of response variable that scales to 0.0 in the driver.</span>
<span class="sd">        index : int, optional</span>
<span class="sd">            If variable is an array, this indicates which entry is of</span>
<span class="sd">            interest for this particular response. This may be a positive</span>
<span class="sd">            or negative integer.  If present, this overrides loc.</span>
<span class="sd">        adder : float or ndarray, optional</span>
<span class="sd">            Value to add to the model value to get the scaled value. Adder</span>
<span class="sd">            is first in precedence.</span>
<span class="sd">        scaler : float or ndarray, optional</span>
<span class="sd">            value to multiply the model value to get the scaled value. Scaler</span>
<span class="sd">            is second in precedence.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warn_deprecation</span><span class="p">(</span><span class="s1">&#39;set_objective has been replaced with add_objective&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">ref0</span><span class="o">=</span><span class="n">ref0</span><span class="p">,</span>
                           <span class="n">adder</span><span class="o">=</span><span class="n">adder</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="n">scaler</span><span class="p">,</span> <span class="n">parallel_deriv_color</span><span class="o">=</span><span class="n">parallel_deriv_color</span><span class="p">,</span>
                           <span class="n">vectorize_derivs</span><span class="o">=</span><span class="n">vectorize_derivs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_path</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">adder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parallel_deriv_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">vectorize_derivs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by add_objective in classes that derive from PhaseBase.  Each subclass is responsible</span>
<span class="sd">        for determining the objective paht in the system.  This method then figures out the correct</span>
<span class="sd">        index based on the given loc and index attributes, and calls the standard add_objective</span>
<span class="sd">        method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the objective variable.  This should be one of &#39;time&#39;, a state or control</span>
<span class="sd">            variable, or the path to an output from the top level of the RHS.</span>
<span class="sd">        loc : str</span>
<span class="sd">            Where in the phase the objective is to be evaluated.  Valid</span>
<span class="sd">            options are &#39;initial&#39; and &#39;final&#39;.  The default is &#39;final&#39;.</span>
<span class="sd">        index : int, optional</span>
<span class="sd">            If variable is an array at each point in time, this indicates which index is to be</span>
<span class="sd">            used as the objective, assuming C-ordered flattening.</span>
<span class="sd">        shape : int, optional</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obj_path : str</span>
<span class="sd">            The name of the variable in the phase to be used as an objective.</span>
<span class="sd">        loc : str</span>
<span class="sd">            One of &#39;initial&#39; or &#39;final&#39;, depending on where in the phase the objective should be</span>
<span class="sd">            measured.</span>
<span class="sd">        index : int or None</span>
<span class="sd">            The index into the flattened shape giving the index at an instance in time to be used</span>
<span class="sd">            as the objective.  This index assumes row-major (C) ordering when flattening.</span>
<span class="sd">        shape : tuple</span>
<span class="sd">            The shape of the objective variable, at a point in time</span>
<span class="sd">        ref : float or ndarray, optional</span>
<span class="sd">            Value of response variable that scales to 1.0 in the driver.</span>
<span class="sd">        ref0 : float or ndarray, optional</span>
<span class="sd">            Value of response variable that scales to 0.0 in the driver.</span>
<span class="sd">        adder : float or ndarray, optional</span>
<span class="sd">            Value to add to the model value to get the scaled value. Adder</span>
<span class="sd">            is first in precedence.</span>
<span class="sd">        scaler : float or ndarray, optional</span>
<span class="sd">            value to multiply the model value to get the scaled value. Scaler</span>
<span class="sd">            is second in precedence.</span>
<span class="sd">        parallel_deriv_color : string</span>
<span class="sd">            If specified, this design var will be grouped for parallel derivative</span>
<span class="sd">            calculations with other variables sharing the same parallel_deriv_color.</span>
<span class="sd">        vectorize_derivs : bool</span>
<span class="sd">            If True, vectorize derivative calculations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Objective variable is non-scaler </span><span class="si">{0}</span><span class="s1"> but no index specified &#39;</span>
                             <span class="s1">&#39;for objective&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">index</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">idx</span>

        <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">size</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Objective index=</span><span class="si">{0}</span><span class="s1">, but the shape of the objective &#39;</span>
                             <span class="s1">&#39;variable is </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">shape</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="s1">&#39;final&#39;</span><span class="p">:</span>
            <span class="n">obj_index</span> <span class="o">=</span> <span class="o">-</span><span class="n">size</span> <span class="o">+</span> <span class="n">idx</span>
        <span class="k">elif</span> <span class="n">loc</span> <span class="o">==</span> <span class="s1">&#39;initial&#39;</span><span class="p">:</span>
            <span class="n">obj_index</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid value for objective loc: </span><span class="si">{0}</span><span class="s1">. Must be &#39;</span>
                             <span class="s1">&#39;one of </span><span class="se">\&#39;</span><span class="s1">initial</span><span class="se">\&#39;</span><span class="s1"> or </span><span class="se">\&#39;</span><span class="s1">final</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">PhaseBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">obj_path</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">ref0</span><span class="o">=</span><span class="n">ref0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">obj_index</span><span class="p">,</span>
                                             <span class="n">adder</span><span class="o">=</span><span class="n">adder</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="n">scaler</span><span class="p">,</span>
                                             <span class="n">parallel_deriv_color</span><span class="o">=</span><span class="n">parallel_deriv_color</span><span class="p">,</span>
                                             <span class="n">vectorize_derivs</span><span class="o">=</span><span class="n">vectorize_derivs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_time_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt_initial</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">opt_duration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                         <span class="n">initial_bounds</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">initial_scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">initial_adder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_ref0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">duration</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">duration_bounds</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">duration_scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">duration_adder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">duration_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">duration_ref0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set options for the time (or the integration variable) in the Phase.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        opt_initial : bool</span>
<span class="sd">            If True, the initial time of the phase is a design variable</span>
<span class="sd">            for optimization, otherwise False.</span>
<span class="sd">        opt_duration : bool</span>
<span class="sd">            If True, the duration of the phase is a design variable</span>
<span class="sd">            for optimization, otherwise False.</span>
<span class="sd">        initial : float</span>
<span class="sd">            Default value of the time at the start of the phase.</span>
<span class="sd">        initial_bounds : Iterable of size 2</span>
<span class="sd">            Tuple of (lower, upper) bounds for time at the start of the phase.</span>
<span class="sd">        initial_scaler : float</span>
<span class="sd">            Scalar for the initial value of time.</span>
<span class="sd">        initial_adder : float</span>
<span class="sd">            Adder for the initial value of time.</span>
<span class="sd">        inital_ref0 : float</span>
<span class="sd">            Zero-reference value for the initial value of time.</span>
<span class="sd">        initial_ref : float</span>
<span class="sd">            Unit-reference value for the initial value of time.</span>
<span class="sd">        duration : float</span>
<span class="sd">            Value of the duration of time across the phase.</span>
<span class="sd">        duration_bounds : Iterable of size 2</span>
<span class="sd">            Tuple of (lower, upper) bounds for the duration of time</span>
<span class="sd">            across the phase.</span>
<span class="sd">        duration_scaler : float</span>
<span class="sd">            Scalar for the duration of time across the phase.</span>
<span class="sd">        duration_adder : float</span>
<span class="sd">            Adder for the duration of time across the phase.</span>
<span class="sd">        duration_ref0 : float</span>
<span class="sd">            Zero-reference value for the duration of time across the phase.</span>
<span class="sd">        duration_ref : float</span>
<span class="sd">            Unit-reference value for the duration of time across the phase.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Don&#39;t allow the user to provide desvar options if the control is not optimal</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opt_initial</span><span class="p">:</span>
            <span class="n">illegal_options</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">initial_bounds</span> <span class="o">!=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;initial_bounds&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initial_scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;initial_scaler&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initial_adder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;initial_adder&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initial_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;initial_ref&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initial_ref0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;initial_ref0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">illegal_options</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Invalid options for fixed &#39;</span> \
                      <span class="s1">&#39;initial time: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">illegal_options</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opt_duration</span><span class="p">:</span>
            <span class="n">illegal_options</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">duration_bounds</span> <span class="o">!=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;duration_bounds&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">duration_scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;duration_scaler&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">duration_adder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;duration_adder&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">duration_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;duration_ref&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">duration_ref0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">illegal_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;duration_ref0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">illegal_options</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Invalid options for fixed &#39;</span> \
                      <span class="s1">&#39;duration: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">illegal_options</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;opt_initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt_initial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;initial_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;initial_scaler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_scaler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;initial_adder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_adder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;initial_ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;initial_ref0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_ref0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;opt_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt_duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;duration_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration_bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;duration_scaler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration_scaler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;duration_adder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration_adder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;duration_ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;duration_ref0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration_ref0</span>

    <span class="k">def</span> <span class="nf">_classify_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classifies a variable of the given name or path.</span>

<span class="sd">        This method searches for it as a time variable, state variable,</span>
<span class="sd">        control variable, or parameter.  If it is not found to be one</span>
<span class="sd">        of those variables, it is assumed to be the path to a variable</span>
<span class="sd">        relative to the top of the ODE system for the phase.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var : str</span>
<span class="sd">            The name of the variable to be classified.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The classification of the given variable, which is one of</span>
<span class="sd">            &#39;time&#39;, &#39;state&#39;, &#39;control&#39;, &#39;control_rate&#39;,</span>
<span class="sd">            &#39;control_rate2&#39;, or &#39;rhs&#39;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;time&#39;</span>
        <span class="k">elif</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;state&#39;</span>
        <span class="k">elif</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;indep_control&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;input_control&#39;</span>
        <span class="k">elif</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;indep_design_parameter&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;input_design_parameter&#39;</span>
        <span class="k">elif</span> <span class="n">var</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_rate&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">var</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;control_rate&#39;</span>
        <span class="k">elif</span> <span class="n">var</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_rate2&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">var</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;control_rate2&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;rhs&#39;</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">transcription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;transcription&#39;</span><span class="p">]</span>
        <span class="n">num_segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;num_segments&#39;</span><span class="p">]</span>
        <span class="n">transcription_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;transcription_order&#39;</span><span class="p">]</span>
        <span class="n">segment_ends</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;segment_ends&#39;</span><span class="p">]</span>
        <span class="n">compressed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;compressed&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">transcription_order</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Given transcription order (</span><span class="si">{0}</span><span class="s1">) is less than &#39;</span>
                             <span class="s1">&#39;the minimum allowed value (3)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transcription_order</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span> <span class="o">=</span> <span class="n">grid_data</span> <span class="o">=</span> <span class="n">GridData</span><span class="p">(</span>
            <span class="n">num_segments</span><span class="o">=</span><span class="n">num_segments</span><span class="p">,</span> <span class="n">transcription</span><span class="o">=</span><span class="n">transcription</span><span class="p">,</span>
            <span class="n">transcription_order</span><span class="o">=</span><span class="n">transcription_order</span><span class="p">,</span>
            <span class="n">segment_ends</span><span class="o">=</span><span class="n">segment_ends</span><span class="p">,</span>
            <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_time_extents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_time</span><span class="p">()</span>

        <span class="c1"># Declare control_rate comp to which we&#39;ll connect controls and parameters.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">:</span>
            <span class="n">ctrl_rate_comp</span> <span class="o">=</span> <span class="n">ControlRateComp</span><span class="p">(</span><span class="n">control_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">,</span>
                                             <span class="n">time_units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
                                             <span class="n">grid_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span><span class="p">)</span>

            <span class="n">promoted_outputs</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_controls</span><span class="p">()</span>
            <span class="n">promoted_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;control_rates:*&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;control_rate_comp&#39;</span><span class="p">,</span> <span class="n">subsys</span><span class="o">=</span><span class="n">ctrl_rate_comp</span><span class="p">,</span>
                               <span class="n">promotes_outputs</span><span class="o">=</span><span class="n">promoted_outputs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;time.dt_dstau&#39;</span><span class="p">,</span> <span class="s1">&#39;control_rate_comp.dt_dstau&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_design_parameters</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_rhs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_defects</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_states</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_endpoint_conditions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_boundary_constraints</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_path_constraints</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_unprovided_controls</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup up the time component and time extents for the phase.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        comps</span>
<span class="sd">            A list of the component names needed for time extents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
        <span class="n">grid_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span>

        <span class="n">indeps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">externals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;opt_initial&#39;</span><span class="p">]:</span>
            <span class="n">indeps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;t_initial&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;t_initial&#39;</span><span class="p">,</span> <span class="s1">&#39;time.t_initial&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">externals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;t_initial&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;opt_duration&#39;</span><span class="p">]:</span>
            <span class="n">indeps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;t_duration&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;t_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;time.t_duration&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">externals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;t_duration&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">indeps</span><span class="p">:</span>
            <span class="n">indep</span> <span class="o">=</span> <span class="n">IndepVarComp</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">indeps</span><span class="p">:</span>
                <span class="n">indep</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time_units</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;time_extents&#39;</span><span class="p">,</span> <span class="n">indep</span><span class="p">,</span> <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span>
            <span class="n">comps</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;time_extents&#39;</span><span class="p">]</span>

        <span class="n">time_comp</span> <span class="o">=</span> <span class="n">TimeComp</span><span class="p">(</span><span class="n">grid_data</span><span class="o">=</span><span class="n">grid_data</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time_units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">time_comp</span><span class="p">,</span> <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">promotes_inputs</span><span class="o">=</span><span class="n">externals</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;opt_initial&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="s1">&#39;t_initial&#39;</span><span class="p">,</span>
                                <span class="n">lower</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;initial_bounds&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">upper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;initial_bounds&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                <span class="n">scaler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;initial_scaler&#39;</span><span class="p">],</span>
                                <span class="n">adder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;initial_adder&#39;</span><span class="p">],</span>
                                <span class="n">ref0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;initial_ref0&#39;</span><span class="p">],</span>
                                <span class="n">ref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;initial_ref&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;opt_duration&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="s1">&#39;t_duration&#39;</span><span class="p">,</span>
                                <span class="n">lower</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;duration_bounds&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">upper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;duration_bounds&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                <span class="n">scaler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;duration_scaler&#39;</span><span class="p">],</span>
                                <span class="n">adder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;duration_adder&#39;</span><span class="p">],</span>
                                <span class="n">ref0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;duration_ref0&#39;</span><span class="p">],</span>
                                <span class="n">ref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;duration_ref&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">comps</span>

    <span class="k">def</span> <span class="nf">_setup_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds an IndepVarComp if necessary and issues appropriate connections based</span>
<span class="sd">        on transcription.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opt_controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">)</span> <span class="k">if</span> <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]]</span>

        <span class="n">num_opt_controls</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">opt_controls</span><span class="p">)</span>

        <span class="n">num_input_controls</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_opt_controls</span>

        <span class="n">grid_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span>

        <span class="k">if</span> <span class="n">num_opt_controls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">indep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;indep_controls&#39;</span><span class="p">,</span> <span class="n">subsys</span><span class="o">=</span><span class="n">IndepVarComp</span><span class="p">(),</span>
                                       <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">num_input_controls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">passthru</span> <span class="o">=</span> <span class="n">ControlInputComp</span><span class="p">(</span><span class="n">num_nodes</span><span class="o">=</span><span class="n">grid_data</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
                                        <span class="n">control_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;input_controls&#39;</span><span class="p">,</span> <span class="n">subsys</span><span class="o">=</span><span class="n">passthru</span><span class="p">,</span> <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
                               <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span>

        <span class="n">num_dynamic_controls</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;dynamic&#39;</span><span class="p">]:</span>
                    <span class="c1"># Dynamic controls</span>
                    <span class="n">num_dynamic_controls</span> <span class="o">=</span> <span class="n">num_dynamic_controls</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">num_input_nodes</span> <span class="o">=</span> <span class="n">grid_data</span><span class="o">.</span><span class="n">num_dynamic_control_input_nodes</span>
                    <span class="n">map_indices_to_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span><span class="o">.</span><span class="n">input_maps</span><span class="p">[</span><span class="s1">&#39;dynamic_control_input_to_disc&#39;</span><span class="p">]</span>

                    <span class="n">desvar_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span><span class="o">.</span><span class="n">num_dynamic_control_input_nodes</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;fix_initial&#39;</span><span class="p">]:</span>
                        <span class="n">desvar_indices</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;fix_final&#39;</span><span class="p">]:</span>
                        <span class="n">desvar_indices</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">desvar_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">coerce_desvar</span> <span class="o">=</span> <span class="n">CoerceDesvar</span><span class="p">(</span><span class="n">grid_data</span><span class="o">.</span><span class="n">subset_num_nodes</span><span class="p">[</span><span class="s1">&#39;control_disc&#39;</span><span class="p">],</span>
                                                     <span class="n">desvar_indices</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;controls:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                                            <span class="n">lower</span><span class="o">=</span><span class="n">coerce_desvar</span><span class="p">(</span><span class="s1">&#39;lower&#39;</span><span class="p">),</span>
                                            <span class="n">upper</span><span class="o">=</span><span class="n">coerce_desvar</span><span class="p">(</span><span class="s1">&#39;upper&#39;</span><span class="p">),</span>
                                            <span class="n">scaler</span><span class="o">=</span><span class="n">coerce_desvar</span><span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">),</span>
                                            <span class="n">adder</span><span class="o">=</span><span class="n">coerce_desvar</span><span class="p">(</span><span class="s1">&#39;adder&#39;</span><span class="p">),</span>
                                            <span class="n">ref0</span><span class="o">=</span><span class="n">coerce_desvar</span><span class="p">(</span><span class="s1">&#39;ref0&#39;</span><span class="p">),</span>
                                            <span class="n">ref</span><span class="o">=</span><span class="n">coerce_desvar</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">),</span>
                                            <span class="n">indices</span><span class="o">=</span><span class="n">desvar_indices</span><span class="p">)</span>
                <span class="c1"># END DYNAMIC CONTROL</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Static control</span>
                    <span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">map_indices_to_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span><span class="o">.</span><span class="n">subset_num_nodes</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;controls:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                                        <span class="n">lower</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span>
                                        <span class="n">upper</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span>
                                        <span class="n">scaler</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;scaler&#39;</span><span class="p">],</span>
                                        <span class="n">adder</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;adder&#39;</span><span class="p">],</span>
                                        <span class="n">ref0</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ref0&#39;</span><span class="p">],</span>
                                        <span class="n">ref</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">])</span>

                <span class="n">indep</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;controls:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                                 <span class="n">val</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                                 <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_input_nodes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])),</span>
                                 <span class="n">units</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">])</span>
                <span class="c1"># END STATIC CONTROL</span>
                <span class="n">control_src_name</span> <span class="o">=</span> <span class="s1">&#39;controls:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># END OPTIMAL CONTROL</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;dynamic&#39;</span><span class="p">]:</span>
                    <span class="n">map_indices_to_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span><span class="o">.</span><span class="n">input_maps</span><span class="p">[</span><span class="s1">&#39;dynamic_control_input_to_disc&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">map_indices_to_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span><span class="o">.</span><span class="n">subset_num_nodes</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">control_src_name</span> <span class="o">=</span> <span class="s1">&#39;controls:</span><span class="si">{0}</span><span class="s1">_out&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># END INPUT CONTROL</span>

            <span class="c1"># Connect to control rate</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;dynamic&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">control_src_name</span><span class="p">,</span>
                             <span class="s1">&#39;control_rate_comp.controls:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                             <span class="n">src_indices</span><span class="o">=</span><span class="n">map_indices_to_all</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">num_dynamic_controls</span>

    <span class="k">def</span> <span class="nf">_setup_design_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds an IndepVarComp if necessary and issues appropriate connections based</span>
<span class="sd">        on transcription.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opt_design_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">)</span>
                             <span class="k">if</span> <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]]</span>

        <span class="n">num_opt_design_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">opt_design_params</span><span class="p">)</span>

        <span class="n">num_input_design_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_opt_design_params</span>

        <span class="n">grid_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span>

        <span class="k">if</span> <span class="n">num_opt_design_params</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">indep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;indep_design_params&#39;</span><span class="p">,</span> <span class="n">subsys</span><span class="o">=</span><span class="n">IndepVarComp</span><span class="p">(),</span>
                                       <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">num_input_design_params</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">passthru</span> <span class="o">=</span> <span class="n">DesignParameterInputComp</span><span class="p">(</span>
                <span class="n">num_nodes</span><span class="o">=</span><span class="n">grid_data</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
                <span class="n">design_parameter_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;input_design_params&#39;</span><span class="p">,</span> <span class="n">subsys</span><span class="o">=</span><span class="n">passthru</span><span class="p">,</span> <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
                               <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]:</span>
                <span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;design_parameters:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                                    <span class="n">lower</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span>
                                    <span class="n">upper</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span>
                                    <span class="n">scaler</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;scaler&#39;</span><span class="p">],</span>
                                    <span class="n">adder</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;adder&#39;</span><span class="p">],</span>
                                    <span class="n">ref0</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ref0&#39;</span><span class="p">],</span>
                                    <span class="n">ref</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">])</span>

                <span class="n">indep</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;design_parameters:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                                 <span class="n">val</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                                 <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_input_nodes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])),</span>
                                 <span class="n">units</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_setup_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_defects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_endpoint_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_boundary_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds BoundaryConstraintComp if necessary and issues appropriate connections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transcription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;transcription&#39;</span><span class="p">]</span>
        <span class="n">bc_comp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">:</span>
            <span class="n">bc_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;boundary_constraints&#39;</span><span class="p">,</span> <span class="n">subsys</span><span class="o">=</span><span class="n">BoundaryConstraintComp</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_boundary_constraints</span><span class="p">):</span>
            <span class="n">con_name</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;constraint_name&#39;</span><span class="p">]</span>
            <span class="n">con_units</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">con_shape</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>

            <span class="c1"># Determine the path to the variable which we will be constraining</span>
            <span class="n">var_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_var</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">var_type</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">con_units</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">con_units</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">constraint_path</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
            <span class="k">elif</span> <span class="n">var_type</span> <span class="o">==</span> <span class="s1">&#39;state&#39;</span><span class="p">:</span>
                <span class="n">state_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
                <span class="n">state_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_options</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_shape</span> <span class="k">if</span> <span class="n">con_shape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">con_shape</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_units</span> <span class="k">if</span> <span class="n">con_units</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">con_units</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">constraint_path</span> <span class="o">=</span> <span class="s1">&#39;states:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">var_type</span> <span class="o">==</span> <span class="s1">&#39;indep_control&#39;</span><span class="p">:</span>
                <span class="n">control_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
                <span class="n">control_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_shape</span> <span class="k">if</span> <span class="n">con_shape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">con_shape</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_units</span> <span class="k">if</span> <span class="n">con_units</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">con_units</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">constraint_path</span> <span class="o">=</span> <span class="s1">&#39;controls:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">var_type</span> <span class="o">==</span> <span class="s1">&#39;input_control&#39;</span><span class="p">:</span>
                <span class="n">control_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
                <span class="n">control_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_shape</span> <span class="k">if</span> <span class="n">con_shape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">con_shape</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_units</span> <span class="k">if</span> <span class="n">con_units</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">con_units</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">constraint_path</span> <span class="o">=</span> <span class="s1">&#39;controls:</span><span class="si">{0}</span><span class="s1">_out&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">var_type</span> <span class="o">==</span> <span class="s1">&#39;control_rate&#39;</span><span class="p">:</span>
                <span class="n">control_var</span> <span class="o">=</span> <span class="n">var</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">control_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">control_var</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
                <span class="n">control_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">control_var</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
                <span class="n">control_rate_units</span> <span class="o">=</span> <span class="n">get_rate_units</span><span class="p">(</span><span class="n">control_units</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
                                                    <span class="n">deriv</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_shape</span> <span class="k">if</span> <span class="n">con_shape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">con_shape</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_rate_units</span> <span class="k">if</span> <span class="n">con_units</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">con_units</span>
                <span class="n">constraint_path</span> <span class="o">=</span> <span class="s1">&#39;control_rates:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">var_type</span> <span class="o">==</span> <span class="s1">&#39;control_rate2&#39;</span><span class="p">:</span>
                <span class="n">control_var</span> <span class="o">=</span> <span class="n">var</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
                <span class="n">control_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">control_var</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
                <span class="n">control_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">[</span><span class="n">control_var</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
                <span class="n">control_rate_units</span> <span class="o">=</span> <span class="n">get_rate_units</span><span class="p">(</span><span class="n">control_units</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
                                                    <span class="n">deriv</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_shape</span> <span class="k">if</span> <span class="n">con_shape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">con_shape</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_rate_units</span> <span class="k">if</span> <span class="n">con_units</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">con_units</span>
                <span class="n">constraint_path</span> <span class="o">=</span> <span class="s1">&#39;control_rates:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Failed to find variable, assume it is in the RHS</span>
                <span class="k">if</span> <span class="n">transcription</span> <span class="o">==</span> <span class="s1">&#39;gauss-lobatto&#39;</span><span class="p">:</span>
                    <span class="n">constraint_path</span> <span class="o">=</span> <span class="s1">&#39;rhs_disc.</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">transcription</span> <span class="o">==</span> <span class="s1">&#39;radau-ps&#39;</span><span class="p">:</span>
                    <span class="n">constraint_path</span> <span class="o">=</span> <span class="s1">&#39;rhs_all.</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid transcription&#39;</span><span class="p">)</span>

                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con_shape</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con_units</span>

            <span class="k">if</span> <span class="s1">&#39;initial&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;initial&#39;</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
                <span class="n">bc_comp</span><span class="o">.</span><span class="n">_add_initial_constraint</span><span class="p">(</span><span class="n">con_name</span><span class="p">,</span>
                                                <span class="o">**</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;initial&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;final&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;final&#39;</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
                <span class="n">bc_comp</span><span class="o">.</span><span class="n">_add_final_constraint</span><span class="p">(</span><span class="n">con_name</span><span class="p">,</span>
                                              <span class="o">**</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;final&#39;</span><span class="p">])</span>

            <span class="c1"># Build the correct src_indices regardless of shape</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])</span>
            <span class="n">src_idxs_initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])</span>
            <span class="n">src_idxs_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])</span>
            <span class="n">src_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">src_idxs_initial</span><span class="p">,</span> <span class="n">src_idxs_final</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">constraint_path</span><span class="p">,</span>
                         <span class="s1">&#39;boundary_constraints.boundary_values:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">con_name</span><span class="p">),</span>
                         <span class="n">src_indices</span><span class="o">=</span><span class="n">src_idxs</span><span class="p">,</span> <span class="n">flat_src_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_unprovided_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s1">&#39;check_config&#39;</span><span class="p">,</span> <span class="n">use_format</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">unconnected</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ode_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ode_class&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ode_options</span>
        <span class="n">ode_parameters</span> <span class="o">=</span> <span class="n">ode_options</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ode_parameters</span><span class="p">:</span>
            <span class="n">p_is_connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">control_name</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_options</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">control_name</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
                    <span class="n">p_is_connected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;rate_param&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
                    <span class="n">p_is_connected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;rate2_param&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
                    <span class="n">p_is_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_parameter_options</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">param_name</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
                    <span class="n">p_is_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p_is_connected</span><span class="p">:</span>
                <span class="n">unconnected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unconnected</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The following ODE parameters are not provided &#39;</span>
                           <span class="s1">&#39;by phase &quot;</span><span class="si">{0}</span><span class="s1">&quot; as controls or control rates: </span><span class="si">{1}</span><span class="s1">. &#39;</span>
                           <span class="s1">&#39;The default value will be used.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">unconnected</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the values of the given variable at the given</span>
<span class="sd">        subset of nodes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var : str</span>
<span class="sd">            The variable whose values are to be returned.  This may be</span>
<span class="sd">            the name &#39;time&#39;, the name of a state, control, or parameter,</span>
<span class="sd">            or the path to a variable in the ODE system of the phase.</span>
<span class="sd">        nodes : str or None</span>
<span class="sd">            The name of the node subset or None (default).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            An array of the values at the requested node subset.  The</span>
<span class="sd">            node index is the first dimension of the ndarray.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;get_values has not been implemented for this class.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the values of the given variable at the given</span>
<span class="sd">        subset of nodes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var : str</span>
<span class="sd">            The variable whose values are to be returned.  This may be</span>
<span class="sd">            the name &#39;time&#39;, the name of a state, control, or parameter,</span>
<span class="sd">            or the path to a variable in the ODE system of the phase.</span>
<span class="sd">        value : ndarray</span>
<span class="sd">            Array of time/control/state/parameter values.</span>
<span class="sd">        nodes : str</span>
<span class="sd">            The name of the node subset or None (default).</span>
<span class="sd">        kind : str</span>
<span class="sd">            Specifies the kind of interpolation, as per the scipy.interpolate package.</span>
<span class="sd">            One of (&#39;linear&#39;, &#39;nearest&#39;, &#39;zero&#39;, &#39;slinear&#39;, &#39;quadratic&#39;, &#39;cubic&#39;</span>
<span class="sd">            where &#39;zero&#39;, &#39;slinear&#39;, &#39;quadratic&#39; and &#39;cubic&#39; refer to a spline</span>
<span class="sd">            interpolation of zeroth, first, second or third order) or as an</span>
<span class="sd">            integer specifying the order of the spline interpolator to use.</span>
<span class="sd">            Default is &#39;linear&#39;.</span>
<span class="sd">        axis : int</span>
<span class="sd">            Specifies the axis along which interpolation should be performed.  Default is</span>
<span class="sd">            the first axis (0).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;set_values has not been implemented for this class.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="PhaseBase.interpolate"><a class="viewcode-back" href="../../../user_guide/tools_and_components/interpolation.html#dymos.phases.phase_base.PhaseBase.interpolate">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an array of values on [a,b] linearly interpolated to the</span>
<span class="sd">        input nodes of the phase.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xs :  ndarray</span>
<span class="sd">            Array of integration variable values.</span>
<span class="sd">        ys :  ndarray</span>
<span class="sd">            Array of control/state/parameter values.</span>
<span class="sd">        nodes : str or None</span>
<span class="sd">            The name of the node subset or None (default).</span>
<span class="sd">        kind : str</span>
<span class="sd">            Specifies the kind of interpolation, as per the scipy.interpolate package.</span>
<span class="sd">            One of (&#39;linear&#39;, &#39;nearest&#39;, &#39;zero&#39;, &#39;slinear&#39;, &#39;quadratic&#39;, &#39;cubic&#39;</span>
<span class="sd">            where &#39;zero&#39;, &#39;slinear&#39;, &#39;quadratic&#39; and &#39;cubic&#39; refer to a spline</span>
<span class="sd">            interpolation of zeroth, first, second or third order) or as an</span>
<span class="sd">            integer specifying the order of the spline interpolator to use.</span>
<span class="sd">            Default is &#39;linear&#39;.</span>
<span class="sd">        axis : int</span>
<span class="sd">            Specifies the axis along which interpolation should be performed.  Default is</span>
<span class="sd">            the first axis (0).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.array</span>
<span class="sd">            The values of y interpolated at nodes of the specified type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ys must be provided as an Iterable of length at least 2.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nodes</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;disc&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;state_disc&#39;</span><span class="p">,</span> <span class="s1">&#39;control_disc&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;segment_ends&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;nodes must be one of &#39;col&#39;, &#39;disc&#39;, &#39;all&#39;, &#39;state_disc&#39;, &quot;</span>
                             <span class="s2">&quot;&#39;control_disc&#39;, or &#39;segment_ends&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;xs may only be unspecified when len(ys)=2&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">!=</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;kind must be linear when xs is unspecified.&#39;</span><span class="p">)</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;xs must be viewable as a 1D array&#39;</span><span class="p">)</span>

        <span class="n">node_locations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span><span class="o">.</span><span class="n">node_ptau</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span><span class="o">.</span><span class="n">subset_node_indices</span><span class="p">[</span><span class="n">nodes</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;compressed&#39;</span><span class="p">]:</span>
            <span class="n">node_locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">node_locations</span><span class="p">))))</span>
        <span class="c1"># Affine transform xs into tau space [-1, 1]</span>
        <span class="n">_xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">_xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">_xs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="n">_xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">taus</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">_xs</span> <span class="o">+</span> <span class="n">b</span>
        <span class="n">interpfunc</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">taus</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                                          <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">interpfunc</span><span class="p">(</span><span class="n">node_locations</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">res</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">dymos 0.8.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, National Aeronautics and Space Administration.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.6.
    </div>
  </body>
</html>